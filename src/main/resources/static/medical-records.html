<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Медицинские записи</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="navbar">
    <div class="nav-container">
        <div class="logo">Ветклиника</div>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Главная</a>
            <a href="animals.html" class="nav-link">Животные</a>
            <a href="animal-types.html" class="nav-link">Типы животных</a>
            <a href="medical-records.html" class="nav-link">Медицинские записи</a>
        </div>
    </div>
</nav>


<div class="container">

    <h1>Медицинские записи</h1>
    <p class="subtitle">История лечения пациента</p>

    <div class="toolbar">
        <input id="search" placeholder="Поиск по диагнозу или процедуре">
        <button class="btn btn-green" onclick="searchRecords()">Найти</button>
        <button class="btn btn-gray" onclick="loadRecords()">Сбросить</button>
        <button class="btn btn-blue" onclick="openAddForm()">+ Добавить запись</button>
    </div>

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Пациент</th>
            <th>Дата визита</th>
            <th>Диагноз</th>
            <th>Процедура</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody id="recordsTable"></tbody>
    </table>

    <div id="emptyState" class="empty-state" style="display:none;">
        <p>Медицинских записей пока нет</p>
    </div>

    <div class="card" id="addForm" style="display:none;">
        <h3>Новая медицинская запись</h3>

        <div class="form-group" id="animalSelectGroup">
            <label>Пациент</label>
            <select id="animalSelect"></select>
        </div>

        <div class="form-group">
            <label>Дата визита</label>
            <input id="visitDate" type="date"
                   min="2000-01-01"
                   max="2100-12-31">
        </div>

        <div class="form-group">
            <label>Диагноз</label>
            <input id="diagnosis">
        </div>

        <div class="form-group">
            <label>Процедура</label>
            <input id="procedureType">
        </div>

        <button class="btn btn-green" onclick="addRecord()">Добавить</button>
        <button class="btn btn-gray" onclick="closeAddForm()">Отмена</button>
    </div>

    <div class="card" id="editForm" style="display:none;">
        <h3>Изменить медицинскую запись</h3>

        <input type="hidden" id="editId">

        <div class="form-group">
            <label>Дата визита</label>
            <input id="editVisitDate" type="date"
                   min="2000-01-01"
                   max="2100-12-31">
        </div>

        <div class="form-group">
            <label>Диагноз</label>
            <input id="editDiagnosis">
        </div>

        <div class="form-group">
            <label>Процедура</label>
            <input id="editProcedureType">
        </div>

        <button class="btn btn-green" onclick="saveRecord()">Сохранить</button>
        <button class="btn btn-gray" onclick="closeEditForm()">Отмена</button>
    </div>

</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const animalId = params.get('animalId');

    let records = [];
    let animals = [];


    function handleResponse(response) {
        if (response.ok) {
            return response.json().catch(() => null);
        }

        return response.text().then(text => {
            throw new Error(text);
        });
    }

    function showBackendError(errorText) {
        if (!errorText) {
            alert('Ошибка запроса');
            return;
        }

        const messages = errorText
            .split(';')
            .map(e => e.trim())
            .map(e => {
                const idx = e.indexOf(':');
                return idx !== -1 ? e.slice(idx + 1).trim() : e;
            })
            .filter(e => e.length > 0);

        alert(messages.join('\n'));
    }

    function loadAnimals() {
        fetch('/animals')
            .then(r => r.json())
            .then(data => {
                animals = data;
                const select = document.getElementById('animalSelect');
                select.innerHTML = '';

                data.forEach(a => {
                    const option = document.createElement('option');
                    option.value = a.id;
                    option.textContent = `${a.name} (ID: ${a.id})`;
                    select.appendChild(option);
                });
            });
    }

    function loadRecords() {
        const url = animalId
            ? `/medical-records/by-animal/${animalId}`
            : `/medical-records`;

        fetch(url)
            .then(r => r.json())
            .then(data => {
                records = data;
                renderTable(data);
            });
    }

    function renderTable(data) {
        const body = document.getElementById('recordsTable');
        const empty = document.getElementById('emptyState');
        const table = body.closest('table');

        body.innerHTML = '';

        if (data.length === 0) {
            table.style.display = 'none';
            empty.style.display = 'block';
            return;
        }

        table.style.display = 'table';
        empty.style.display = 'none';

        data.forEach(r => {
            body.innerHTML += `
                <tr>
                    <td>${r.id}</td>
                    <td>
                        ${r.animal
                            ? `<a class="link"
                            href="medical-records.html?animalId=${r.animal.id}">
                            ${r.animal.name}
                            </a>`
                                    : '—'}
                    </td>
                    <td>${r.visitDate}</td>
                    <td>${r.diagnosis}</td>
                    <td>${r.procedureType}</td>
                    <td>
                        <button class="btn btn-orange btn-sm"
                            onclick="openEditForm(${r.id})">
                            Изменить
                        </button>
                        <button class="btn btn-red btn-sm"
                            onclick="deleteRecord(${r.id})">
                            Удалить
                        </button>
                    </td>
                </tr>`;
        });
    }

    function searchRecords() {
        const q = document.getElementById('search').value.toLowerCase();
        renderTable(
            records.filter(r =>
                r.diagnosis.toLowerCase().includes(q) ||
                r.procedureType.toLowerCase().includes(q)
            )
        );
    }

    function addRecord() {
        const selectedAnimalId = animalId
            ? animalId
            : document.getElementById('animalSelect').value;

        if (!selectedAnimalId) {
            alert('Выберите пациента');
            return;
        }

        fetch('/medical-records', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                visitDate: visitDate.value,
                diagnosis: diagnosis.value,
                procedureType: procedureType.value,
                animal: { id: selectedAnimalId }
            })
        })
            .then(handleResponse)
            .then(() => {
                closeAddForm();
                loadRecords();
            })
            .catch(err => showBackendError(err.message));
    }


    function openAddForm() {
        document.getElementById('addForm').style.display = 'block';
        window.scrollTo(0, document.body.scrollHeight);
    }

    function closeAddForm() {
        document.getElementById('addForm').style.display = 'none';
    }

    function openEditForm(id) {
        const record = records.find(r => r.id === id);

        document.getElementById('editId').value = record.id;
        document.getElementById('editVisitDate').value = record.visitDate;
        document.getElementById('editDiagnosis').value = record.diagnosis;
        document.getElementById('editProcedureType').value = record.procedureType;

        document.getElementById('editForm').style.display = 'block';
        window.scrollTo(0, document.body.scrollHeight);
    }

    function saveRecord() {
        const id = document.getElementById('editId').value;

        fetch('/medical-records/' + id, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                visitDate: editVisitDate.value,
                diagnosis: editDiagnosis.value,
                procedureType: editProcedureType.value
            })
        })
            .then(handleResponse)
            .then(() => {
                closeEditForm();
                loadRecords();
            })
            .catch(err => showBackendError(err.message));
    }

    function closeEditForm() {
        document.getElementById('editForm').style.display = 'none';
    }


    function deleteRecord(id) {
        if (!confirm('Удалить запись?')) return;
        fetch('/medical-records/' + id, { method: 'DELETE' })
            .then(loadRecords);
    }

    if (animalId) {
        document.getElementById('animalSelectGroup').style.display = 'none';
    } else {
        loadAnimals();
    }

    loadRecords();
</script>

<script>
    document.querySelectorAll('.nav-link').forEach(link => {
        if (link.href === window.location.href) {
            link.classList.add('active');
        }
    });
</script>

</body>
</html>
