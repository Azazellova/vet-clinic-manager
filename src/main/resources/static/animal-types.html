<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Типы животных</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="navbar">
    <div class="nav-container">
        <div class="logo">Ветклиника</div>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Главная</a>
            <a href="animals.html" class="nav-link">Животные</a>
            <a href="animal-types.html" class="nav-link">Типы животных</a>
            <a href="medical-records.html" class="nav-link">Медицинские записи</a>
        </div>
    </div>
</nav>


<div class="container">

    <h1>Типы животных</h1>
    <p class="subtitle">Справочник видов животных</p>

    <div class="toolbar">
        <input id="search" placeholder="Поиск по названию...">
        <button class="btn btn-green" onclick="searchTypes()">Найти</button>
        <button class="btn btn-gray" onclick="loadTypes()">Сбросить</button>
        <button class="btn btn-blue" onclick="openAddForm()">+ Добавить тип</button>
    </div>

    <div class="count">
        Всего типов: <span id="count">0</span>
    </div>

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Название</th>
            <th>Средняя продолжительность жизни</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody id="typesTable"></tbody>
    </table>

    <div id="emptyState" class="empty-state" style="display:none;">
        <p> Типы животных пока не добавлены</p>
    </div>

    <div class="card" id="addForm" style="display:none;">
        <h3>Добавить тип животного</h3>

        <div class="form-group">
            <label>Название</label>
            <input id="typeName" placeholder="Например: Собака">
        </div>

        <div class="form-group">
            <label>Средняя продолжительность жизни</label>
            <input id="lifespan" type="number" placeholder="Лет">
        </div>

        <button class="btn btn-green" onclick="addType()">Сохранить</button>
        <button class="btn btn-gray" onclick="closeAddForm()">Отмена</button>
    </div>

    <div class="card" id="editForm" style="display:none;">
        <h3>Изменить тип животного</h3>

        <input type="hidden" id="editId">

        <div class="form-group">
            <label>Название</label>
            <input id="editName">
        </div>

        <div class="form-group">
            <label>Средняя продолжительность жизни</label>
            <input id="editLifespan" type="number">
        </div>

        <button class="btn btn-green" onclick="saveType()">Сохранить</button>
        <button class="btn btn-gray" onclick="closeEditForm()">Отмена</button>
    </div>

</div>

<script>
    let types = [];

    function loadTypes() {
        fetch('/animal-types')
            .then(r => r.json())
            .then(data => {
                types = data;
                renderTable(data);
            });
    }

    function handleResponse(response) {
        if (response.ok) {
            return response.json().catch(() => null);
        }

        return response.text().then(text => {
            throw new Error(text);
        });
    }

    function showBackendError(errorText) {
        if (!errorText) {
            alert('Ошибка запроса');
            return;
        }

        const messages = errorText
            .split(';')
            .map(e => e.trim())
            .map(e => {
                const idx = e.indexOf(':');
                return idx !== -1 ? e.slice(idx + 1).trim() : e;
            })
            .filter(e => e.length > 0);

        alert(messages.join('\n'));
    }

    function renderTable(data) {
        const tbody = document.getElementById('typesTable');
        const empty = document.getElementById('emptyState');
        const table = tbody.closest('table');

        tbody.innerHTML = '';
        document.getElementById('count').textContent = data.length;

        if (data.length === 0) {
            table.style.display = 'none';
            empty.style.display = 'block';
            return;
        }

        table.style.display = 'table';
        empty.style.display = 'none';

        data.forEach(t => {
            tbody.innerHTML += `
                <tr>
                    <td>${t.id}</td>
                    <td class="link">${t.name}</td>
                    <td>${t.averageLifespan ?? '—'}</td>
                    <td>
                        <button class="btn btn-orange btn-sm"
                            onclick="openEditForm(${t.id})">
                            Изменить
                        </button>
                        <button class="btn btn-red btn-sm"
                            onclick="deleteType(${t.id})">
                            Удалить
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    function searchTypes() {
        const q = document.getElementById('search').value.toLowerCase();

        renderTable(
            types.filter(t =>
                t.name.toLowerCase().includes(q)
            )
        );
    }

    function openAddForm() {
        document.getElementById('addForm').style.display = 'block';
        window.scrollTo(0, document.body.scrollHeight);
    }

    function closeAddForm() {
        document.getElementById('addForm').style.display = 'none';
    }

    function searchRecords() {
        const q = document.getElementById('search').value.toLowerCase();
        renderTable(
            records.filter(r =>
                r.diagnosis.toLowerCase().includes(q) ||
                r.procedureType.toLowerCase().includes(q)
            )
        );
    }

    function addType() {
        const name = document.getElementById('typeName').value.trim();
        const lifespan = document.getElementById('lifespan').value;

        if (!name) {
            alert('Введите название типа');
            return;
        }

        fetch('/animal-types', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                averageLifespan: lifespan || null
            })
        })
            .then(handleResponse)
            .then(() => {
                document.getElementById('typeName').value = '';
                document.getElementById('lifespan').value = '';
                closeAddForm();
                loadTypes();
            })
            .catch(err => showBackendError(err.message));
    }

    function saveType() {
        const id = editId.value;
        const name = editName.value.trim();
        const lifespan = editLifespan.value;

        if (!name) {
            alert('Название обязательно');
            return;
        }

        fetch('/animal-types/' + id, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                averageLifespan: lifespan || null
            })
        })
            .then(handleResponse)
            .then(() => {
                closeEditForm();
                loadTypes();
            })
            .catch(err => showBackendError(err.message));
    }


    function openEditForm(id) {
        const t = types.find(x => x.id === id);

        editId.value = t.id;
        editName.value = t.name;
        editLifespan.value = t.averageLifespan ?? '';

        document.getElementById('editForm').style.display = 'block';
        window.scrollTo(0, document.body.scrollHeight);
    }

    function closeEditForm() {
        document.getElementById('editForm').style.display = 'none';
    }


    function deleteType(id) {
        if (!confirm('Удалить тип животного?')) {
            return;
        }

        fetch(`/animal-types/${id}`, { method: 'DELETE' })
            .then(loadTypes);
    }

    loadTypes();
</script>

<script>
    document.querySelectorAll('.nav-link').forEach(link => {
        if (link.href === window.location.href) {
            link.classList.add('active');
        }
    });
</script>


</body>
</html>
